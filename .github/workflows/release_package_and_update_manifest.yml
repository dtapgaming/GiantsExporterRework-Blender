name: Package Addon + Update Manifest

on:
  release:
    # IMPORTANT:
    # - "edited" fires when you edit the release body/notes.
    # - Toggling prerelease <-> release often fires "prereleased" or "released" (not always "edited").
    # - Keeping all of these ensures "Update release" reliably triggers this workflow.
    types: [published, edited, prereleased, released]

permissions:
  contents: write

jobs:
  package-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Debug release event payload
        run: |
          echo "github.event.action=${{ github.event.action }}"
          echo "tag=${{ github.event.release.tag_name }}"
          echo "prerelease=${{ github.event.release.prerelease }}"
          echo "draft=${{ github.event.release.draft }}"
          echo "html_url=${{ github.event.release.html_url }}"

      # ------------------------------------------------------------
      # Only on "published": checkout tag, build zip, upload asset
      # ------------------------------------------------------------
      - name: Checkout release tag
        if: ${{ github.event.action == 'published' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Build addon zip (io_export_i3d_reworked.zip)
        if: ${{ github.event.action == 'published' }}
        run: |
          test -d io_export_i3d_reworked
          rm -f io_export_i3d_reworked.zip
          zip -r io_export_i3d_reworked.zip io_export_i3d_reworked

      - name: Upload asset to GitHub Release
        if: ${{ github.event.action == 'published' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" io_export_i3d_reworked.zip --clobber

      # ------------------------------------------------------------
      # Always: checkout main into main_branch, update manifest, commit
      # (Runs on published + edited + prereleased + released)
      # ------------------------------------------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main_branch
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Update main/i3dexport_latest.json from release event
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          python main_branch/tools/update_manifest_from_release.py

      - name: Commit and push manifest (main)
        run: |
          cd main_branch
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add i3dexport_latest.json
          git diff --cached --quiet || git commit -m "Update manifest for release"
          git push origin HEAD:main
